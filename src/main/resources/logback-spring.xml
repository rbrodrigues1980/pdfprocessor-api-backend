<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>
    
    <!-- Propriedade para o diretório de logs -->
    <property name="LOG_DIR" value="logs"/>
    <property name="LOG_FILE" value="${LOG_DIR}/fulllog.log"/>
    
    <!-- Pattern do console (formato ISO 8601 com timezone) -->
    <property name="CONSOLE_LOG_PATTERN" 
              value="%d{yyyy-MM-dd'T'HH:mm:ss.SSSXXX} %5p ${PID:- } --- [%15.15t] %-40.40logger{39} : %m%n%wEx"/>
    
    <!-- Pattern para arquivo (mesmo formato do console) -->
    <property name="FILE_LOG_PATTERN" 
              value="%d{yyyy-MM-dd'T'HH:mm:ss.SSSXXX} %5p ${PID:- } --- [%15.15t] %-40.40logger{39} : %m%n%wEx"/>

    <!-- Appender para CONSOLE (texto legível - usado em dev/local) -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>${CONSOLE_LOG_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>

    <!-- Appender JSON estruturado (usado em prod/Cloud Run) -->
    <!-- Cloud Logging parseia JSON automaticamente, permitindo filtragem por campos -->
    <appender name="JSON_CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <includeMdcKeyName>tenantId</includeMdcKeyName>
            <includeMdcKeyName>userId</includeMdcKeyName>
            <timestampPattern>yyyy-MM-dd'T'HH:mm:ss.SSSXXX</timestampPattern>
            <fieldNames>
                <timestamp>timestamp</timestamp>
                <version>[ignore]</version>
                <levelValue>[ignore]</levelValue>
            </fieldNames>
            <shortenedLoggerNameLength>36</shortenedLoggerNameLength>
        </encoder>
    </appender>

    <!-- Appender para ARQUIVO -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_FILE}</file>
        <encoder>
            <pattern>${FILE_LOG_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>
        
        <!-- Política de rotação: rota por tamanho e por data -->
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <!-- Nome do arquivo quando rotaciona: fulllog-2025-12-01.0.log -->
            <fileNamePattern>${LOG_DIR}/fulllog-%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <!-- Tamanho máximo do arquivo antes de rotacionar: 10MB -->
            <maxFileSize>10MB</maxFileSize>
            <!-- Número máximo de arquivos históricos a manter: 5 arquivos -->
            <maxHistory>5</maxHistory>
            <!-- Tamanho total máximo de todos os arquivos de log: 50MB (5 arquivos x 10MB) -->
            <totalSizeCap>50MB</totalSizeCap>
            <!-- Limpar arquivos antigos ao iniciar -->
            <cleanHistoryOnStart>false</cleanHistoryOnStart>
        </rollingPolicy>
        
        <!-- Criar arquivo imediatamente, mesmo se vazio -->
        <prudent>false</prudent>
    </appender>

    <!-- MongoDB Appender Configuration -->
    <springProperty scope="context" name="MONGO_URI" source="spring.data.mongodb.uri"/>
    <springProperty scope="context" name="MONGO_LOGGING_ENABLED" source="app.logging.mongo.enabled" defaultValue="true"/>

    <appender name="MONGO" class="br.com.verticelabs.pdfprocessor.infrastructure.logging.MongoAppender">
        <uri>${MONGO_URI}</uri>
        <collection>logs</collection>
        <retentionDays>30</retentionDays>
        <enabled>${MONGO_LOGGING_ENABLED}</enabled>
    </appender>

    <appender name="ASYNC_MONGO" class="ch.qos.logback.classic.AsyncAppender">
        <appender-ref ref="MONGO" />
        <queueSize>512</queueSize>
        <discardingThreshold>0</discardingThreshold>
        <includeCallerData>false</includeCallerData>
    </appender>

    <!-- ============================================================ -->
    <!-- PERFIL PROD (Cloud Run): otimizado para custo mínimo        -->
    <!-- Cloud Run já fornece request logs grátis (status, latência,  -->
    <!-- IP, user-agent). A aplicação loga apenas eventos críticos.   -->
    <!-- ============================================================ -->
    <springProfile name="prod">
        <!-- Root WARN: apenas warnings e errors por padrão -->
        <!-- JSON_CONSOLE para Cloud Logging parsear campos automaticamente -->
        <root level="WARN">
            <appender-ref ref="JSON_CONSOLE"/>
        </root>

        <!-- Auth/Segurança: INFO para auditoria (login, falhas, tokens) -->
        <logger name="br.com.verticelabs.pdfprocessor.application.auth" level="INFO"/>
        <logger name="br.com.verticelabs.pdfprocessor.infrastructure.security" level="INFO"/>

        <!-- Processamento de documentos: INFO para resultados de negócio -->
        <logger name="br.com.verticelabs.pdfprocessor.application.documents" level="INFO"/>

        <!-- Exceptions tratadas: INFO para erros capturados pelo handler -->
        <logger name="br.com.verticelabs.pdfprocessor.interfaces.exception" level="INFO"/>

        <!-- Startup/Config: INFO para diagnóstico na inicialização -->
        <logger name="br.com.verticelabs.pdfprocessor.infrastructure.config" level="INFO"/>

        <!-- Bibliotecas externas: silenciar em prod -->
        <logger name="org.springframework" level="WARN"/>
        <logger name="org.mongodb" level="WARN"/>
        <logger name="org.mongodb.driver" level="WARN"/>
        <logger name="org.apache.tika" level="ERROR"/>
        <logger name="org.apache.pdfbox" level="ERROR"/>
        <logger name="reactor.netty" level="WARN"/>
        <logger name="io.netty" level="WARN"/>
    </springProfile>

    <!-- ============================================================ -->
    <!-- PERFIL NÃO-PROD (local, docker, dev): logging completo      -->
    <!-- ============================================================ -->
    <springProfile name="!prod">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="FILE"/>
            <appender-ref ref="ASYNC_MONGO"/>
        </root>

        <!-- Loggers específicos para reduzir verbosidade de bibliotecas -->
        <logger name="org.springframework" level="INFO"/>
        <logger name="org.mongodb" level="INFO"/>
        <logger name="org.mongodb.driver" level="INFO"/>
        <logger name="org.apache.tika" level="WARN"/>
        <logger name="org.apache.pdfbox" level="WARN"/>
        <logger name="reactor.netty" level="INFO"/>
        <logger name="io.netty" level="INFO"/>

        <!-- Aplicação: INFO em desenvolvimento -->
        <logger name="br.com.verticelabs.pdfprocessor" level="INFO"/>
    </springProfile>

</configuration>

